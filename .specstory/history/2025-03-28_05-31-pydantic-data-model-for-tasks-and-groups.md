<!-- Generated by SpecStory -->

# Pydantic Data Model for Tasks and Groups (2025-03-28 13:31:06)

_**User**_

Please create Pydantic data model for the status
You should create Task and Group separately
And then the `get_status` becomes return
{"tasks": {Task...}, "groups": {Group...}}

---

_**Assistant**_



---

```bash
pueue status --json | head -5
```

---

```bash
pip list | grep pydantic
```

```
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗ pip list | grep pydantic
pydantic                                          2.10.6
pydantic_core                                     2.27.2
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗
```

---

```diff
  import subprocess
  from loguru import logger
+ import json
+ from typing import Dict, List, Optional, Union, Any
+ from datetime import datetime
+ from pydantic import BaseModel, Field
+ 
+ 
+ class TaskStatusInfo(BaseModel):
+     enqueued_at: datetime
+     start: datetime
+     end: datetime
+     result: str
+ 
+ 
+ class TaskStatus(BaseModel):
+     # The status can be different types: Done, Running, Queued, etc.
+     # Using a dict with single key-value pair to represent the status type and its info
+     __root__: Dict[str, TaskStatusInfo]
+ 
+     def __getattr__(self, name):
+         if name in self.__root__:
+             return self.__root__[name]
+         raise AttributeError(f"{name} not found")
+ 
+ 
+ class Task(BaseModel):
+     id: int
+     created_at: datetime
+     original_command: str
+     command: str
+     path: str
+     envs: Dict[str, str]
+     group: str
+     dependencies: List[int]
+     priority: int
+     label: Optional[str] = None
+     status: TaskStatus
+ 
+ 
+ class Group(BaseModel):
+     status: str
+     parallel_tasks: int
+ 
+ 
+ class PueueStatus(BaseModel):
+     tasks: Dict[str, Task]
+     groups: Dict[str, Group]
  
  
          return task_id
  
-     async def get_status(self) -> str:
+     async def get_status(self) -> PueueStatus:
          """
          Retrieves the status of all tasks.
          """
-         # TODO: we should get JSON format
-         return await self._run_pueue_command("status")
+         # Get status in JSON format
+         status_output = await self._run_pueue_command("status", "--json")
+         status_data = json.loads(status_output)
+         return PueueStatus(**status_data)
  
      async def get_log(self, task_id: str) -> str:
      )
  
-     logger.info(await pueue.get_status())
+     # Get structured status
+     status = await pueue.get_status()
+     task_ids = list(status.tasks.keys())
+     logger.info(f"Tasks: {task_ids}")
+     logger.info(f"Default group status: {status.groups['default'].status}")
  
  
```

---

```bash
python pueue_wrapper.py
```

```
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗ python pueue_wrapper.py
Traceback (most recent call last):
  File "/Users/daviddwlee84/Documents/Program/Personal/PueueWrapper/pueue_wrapper.py", line 17, in <module>
    class TaskStatus(BaseModel):
  File "/Users/daviddwlee84/Documents/Program/Personal/PueueWrapper/.venv/lib/python3.12/site-packages/pydan
tic/_internal/_model_construction.py", line 112, in __new__
    private_attributes = inspect_namespace(
                         ^^^^^^^^^^^^^^^^^^
  File "/Users/daviddwlee84/Documents/Program/Personal/PueueWrapper/.venv/lib/python3.12/site-packages/pydan
tic/_internal/_model_construction.py", line 402, in inspect_namespace
    raise TypeError("To define root models, use `pydantic.RootModel` rather than a field called '__root__'")
TypeError: To define root models, use `pydantic.RootModel` rather than a field called '__root__'
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗
```

---

```diff
  from typing import Dict, List, Optional, Union, Any
  from datetime import datetime
- from pydantic import BaseModel, Field
+ from pydantic import BaseModel, Field, RootModel
  
  
  
  class TaskStatus(BaseModel):
-     # The status can be different types: Done, Running, Queued, etc.
-     # Using a dict with single key-value pair to represent the status type and its info
-     __root__: Dict[str, TaskStatusInfo]
- 
-     def __getattr__(self, name):
-         if name in self.__root__:
-             return self.__root__[name]
-         raise AttributeError(f"{name} not found")
+     status_type: str
+     info: TaskStatusInfo
+     
+     @classmethod
+     def model_validate(cls, obj: Dict[str, Any], **kwargs):
+         if len(obj) == 1:
+             status_type = next(iter(obj))
+             return cls(
+                 status_type=status_type,
+                 info=TaskStatusInfo.model_validate(obj[status_type])
+             )
+         raise ValueError("TaskStatus must have exactly one key-value pair")
  
  
          status_output = await self._run_pueue_command("status", "--json")
          status_data = json.loads(status_output)
-         return PueueStatus(**status_data)
+         return PueueStatus.model_validate(status_data)
  
      async def get_log(self, task_id: str) -> str:
      logger.info(f"Tasks: {task_ids}")
      logger.info(f"Default group status: {status.groups['default'].status}")
+     
+     # Log details about first task if any exist
+     if task_ids:
+         first_task = status.tasks[task_ids[0]]
+         logger.info(f"First task command: {first_task.command}")
+         logger.info(f"First task status type: {first_task.status.status_type}")
  
  
```

---

```bash
python pueue_wrapper.py
```

```
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗ python pueue_wrapper.py
2025-03-28 14:22:52.988 | INFO     | __main__:submit_and_wait:104 - Task 3 added, now waiting for it to comp
lete.
2025-03-28 14:22:55.002 | INFO     | __main__:subscribe_to_task:96 - Task 3 finished:
14:22:55 - Task 3 succeeded with 0

2025-03-28 14:22:55.017 | INFO     | __main__:main:134 - Hello, Pueue!

2025-03-28 14:22:55.028 | INFO     | __main__:submit_and_wait:104 - Task 4 added, now waiting for it to comp
lete.
2025-03-28 14:22:55.032 | INFO     | __main__:submit_and_wait:104 - Task 5 added, now waiting for it to comp
lete.
2025-03-28 14:22:59.042 | INFO     | __main__:subscribe_to_task:96 - Task 4 finished:
14:22:57 - Task 4 changed from Queued to Running
14:22:59 - Task 4 succeeded with 0

2025-03-28 14:23:05.052 | INFO     | __main__:subscribe_to_task:96 - Task 5 finished:
14:22:59 - Task 5 changed from Queued to Running
14:23:05 - Task 5 succeeded with 0

Traceback (most recent call last):
  File "/Users/daviddwlee84/Documents/Program/Personal/PueueWrapper/pueue_wrapper.py", line 156, in <module>
    asyncio.run(main())
  File "/Users/daviddwlee84/miniforge3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/Users/daviddwlee84/miniforge3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/daviddwlee84/miniforge3/lib/python3.12/asyncio/base_events.py", line 687, in run_until_comple
te
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/Users/daviddwlee84/Documents/Program/Personal/PueueWrapper/pueue_wrapper.py", line 143, in main
    status = await pueue.get_status()
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/daviddwlee84/Documents/Program/Personal/PueueWrapper/pueue_wrapper.py", line 118, in get_stat
us
    return PueueStatus.model_validate(status_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/daviddwlee84/Documents/Program/Personal/PueueWrapper/.venv/lib/python3.12/site-packages/pydan
tic/main.py", line 693, in model_validate
    return cls.__pydantic_validator__.validate_python(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 12 validation errors for PueueStatus
tasks.0.status.status_type
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.0.status.info
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.1.status.status_type
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.1.status.info
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.2.status.status_type
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.2.status.info
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.3.status.status_type
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.3.status.info
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.4.status.status_type
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.4.status.info
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.5.status.status_type
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
tasks.5.status.info
  Field required [type=missing, input_value={'Done': {'enqueued_at': ...', 'result': 'Success'}}, input_type
=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗
```

---

```bash
pueue status --json | head -n 10
```


---

```diff
      result: str
  
- 
- class TaskStatus(BaseModel):
-     status_type: str
-     info: TaskStatusInfo
- 
-     @classmethod
-     def model_validate(cls, obj: Dict[str, Any], **kwargs):
-         if len(obj) == 1:
-             status_type = next(iter(obj))
-             return cls(
-                 status_type=status_type,
-                 info=TaskStatusInfo.model_validate(obj[status_type]),
-             )
-         raise ValueError("TaskStatus must have exactly one key-value pair")
- 
  
  class Task(BaseModel):
      priority: int
      label: Optional[str] = None
-     status: TaskStatus
+     status: Dict[str, TaskStatusInfo]  # Using Dict directly to handle different status types
  
  
          first_task = status.tasks[task_ids[0]]
          logger.info(f"First task command: {first_task.command}")
-         logger.info(f"First task status type: {first_task.status.status_type}")
+         # Get the status type (e.g., "Done", "Running") and its info
+         status_type = next(iter(first_task.status))
+         status_info = first_task.status[status_type]
+         logger.info(f"First task status: {status_type}, result: {status_info.result}")
  
  
```

---

```bash
python pueue_wrapper.py
```

```
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗ python pueue_wrapper.py
2025-03-28 14:23:43.036 | INFO     | __main__:submit_and_wait:91 - Task 6 added, now waiting for it to compl
ete.
2025-03-28 14:23:45.060 | INFO     | __main__:subscribe_to_task:83 - Task 6 finished:
14:23:45 - Task 6 succeeded with 0

2025-03-28 14:23:45.067 | INFO     | __main__:main:121 - Hello, Pueue!

2025-03-28 14:23:45.074 | INFO     | __main__:submit_and_wait:91 - Task 7 added, now waiting for it to compl
ete.
2025-03-28 14:23:45.078 | INFO     | __main__:submit_and_wait:91 - Task 8 added, now waiting for it to compl
ete.
2025-03-28 14:23:49.095 | INFO     | __main__:subscribe_to_task:83 - Task 7 finished:
14:23:45 - Found active Task 7 with status Running
14:23:49 - Task 7 succeeded with 0

2025-03-28 14:23:55.110 | INFO     | __main__:subscribe_to_task:83 - Task 8 finished:
14:23:49 - Task 8 changed from Queued to Running
14:23:55 - Task 8 succeeded with 0

2025-03-28 14:23:55.129 | INFO     | __main__:main:132 - Tasks: ['0', '1', '2', '3', '4', '5', '6', '7', '8'
]
2025-03-28 14:23:55.129 | INFO     | __main__:main:133 - Default group status: Running
2025-03-28 14:23:55.129 | INFO     | __main__:main:138 - First task command: echo "Hello, Pueue!"
2025-03-28 14:23:55.129 | INFO     | __main__:main:142 - First task status: Done, result: Success
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗
```

---

Great! I've successfully created Pydantic data models for Pueue's status output and updated the `get_status` method to return structured data. The models now properly handle the JSON format returned by the Pueue command-line tool.

Here's what I did:

1. Created `TaskStatusInfo` model to handle the detailed status information (timestamps and result)
2. Created `Task` model that uses a dictionary for the status field to handle different status types (Done, Running, etc.)
3. Created `Group` model to handle group status information
4. Created `PueueStatus` model that combines tasks and groups
5. Updated the `get_status` method to parse JSON and return a validated Pydantic model
6. Added example code showing how to access the task status information

The implementation now allows for type checking and easy access to structured data from Pueue's status output, which will make working with task information much more reliable and maintainable.

---

_**User**_

We should update get status API to use the Pydantic model

---

_**Assistant**_



---

<details>
            <summary>Searched codebase "api.py" • **1** results</summary>
        
| File        |
| ----------- |
| `undefined` |

</details>

---

Read file: api.py

---

```diff
  from fastapi import FastAPI, HTTPException
  from fastapi.responses import StreamingResponse
- from pueue_wrapper import PueueWrapper
+ from pueue_wrapper import PueueWrapper, PueueStatus
  
  # FastAPI setup
  
  @app.get("/api/status")
- async def get_status() -> str:
+ async def get_status() -> PueueStatus:
      """
      List the status of all tasks.
+     Returns a structured PueueStatus object with tasks and groups information.
      """
      try:
```

---

```bash
uvicorn api:app --reload
```

---

```bash
curl -X GET http://127.0.0.1:8000/api/status | head -10
```

```
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗ curl -X GET http://127.0.0.1:8000/api/status | head -10
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
(pueuewrapper) (base) ➜  PueueWrapper git:(main) ✗
```

---

```bash
curl http://127.0.0.1:8000/docs
```

```

    <!DOCTYPE html>
    <html>
    <head>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui.c
ss">
    <link rel="shortcut icon" href="https://fastapi.tiangolo.com/img/favicon.png">
    <title>FastAPI - Swagger UI</title>
    </head>
    <body>
    <div id="swagger-ui">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
    <!-- `SwaggerUIBundle` is now available on the page -->
    <script>
    const ui = SwaggerUIBundle({
        url: '/openapi.json',
    "dom_id": "#swagger-ui",
"layout": "BaseLayout",
"deepLinking": true,
"showExtensions": true,
"showCommonExtensions": true,
oauth2RedirectUrl: window.location.origin + '/docs/oauth2-redirect',
    presets: [
        SwaggerUIBundle.presets.apis,
        SwaggerUIBundle.SwaggerUIStandalonePreset
        ],
    })
    </script>
    </body>
    </html>
    %


```

---

```bash
curl http://127.0.0.1:8000/openapi.json | grep status -A 10
```

---

```bash
curl -X GET "http://127.0.0.1:8000/api/status" -H "accept: application/json" | head -n 20
```


---

Cancelled

---



---

